<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Keranjang Belanja</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f5f7fa;
        }
    
        /* === CHECKBOX === */
        .custom-checkbox {
            width: 20px;
            height: 20px;
            border: 3px solid #0d6efd;
            border-radius: 4px;
            cursor: pointer;
        }
    
        .custom-checkbox:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
    
        .custom-checkbox:focus {
            box-shadow: none;
        }
    
        /* === CARD PRODUK === */
        .cart-item {
            transition: all .2s ease;
        }
    
        .cart-item.active {
            border: 2px solid #0d6efd;
            background: #eef4ff;
        }
    
        /* === SIDEBAR TOTAL === */
        .summary-box {
            position: sticky;
            top: 90px;
        }

    
        .product-link {
            font-size: 13px;
            font-weight: 500;
            color: #0d6efd;
            text-decoration: none;
        }

        .product-link:hover {
            text-decoration: underline;
            color: #0b5ed7;
        }
        
    </style>
</head>

<body>

<div class="container mt-5 mb-5">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold">Keranjang Belanja</h4>
        <a href="/" class="btn btn-outline-secondary btn-sm">
            ← Kembali ke Beranda
        </a>
    </div>

    {% if cart %}
    <div class="row">

        <!-- LIST PRODUK -->
        <div class="col-lg-8">

            <!-- PILIH SEMUA -->
            <div class="card mb-3">
                <div class="card-body d-flex align-items-center gap-2">
                    <input type="checkbox" id="checkAll" class="custom-checkbox">
                    <label for="checkAll" class="fw-semibold">
                        Pilih Semua Produk
                    </label>
                </div>
            </div>

            {% for kode, item in cart.items() %}
            <div class="card mb-3 cart-item" id="item-{{ kode }}">
                <div class="card-body d-flex align-items-center gap-3">

                    <input type="checkbox"
                           class="custom-checkbox item-check"
                           data-harga="{{ item.harga }}"
                           data-qty="{{ item.qty }}">

                    <img src="{{ url_for('static', filename='img/' ~ item.gambar) }}"
                         width="90" class="rounded">

                    <div class="flex-grow-1">
                        <h6 class="mb-1">{{ item.nama }}</h6>
                    
                        <!-- HARGA -->
                        <p class="fw-bold text-primary mb-1">
                            Rp {{ item.harga | rupiah }}
                        </p>
                    
                        <!-- QTY CONTROL -->
                        <div class="d-flex align-items-center gap-2">
                    
                            <button class="btn btn-outline-primary btn-sm qty-btn" onclick="updateQty('{{ kode }}', -1)">
                                −
                            </button>
                    
                            <span class="fw-semibold" id="qty-{{ kode }}">
                                {{ item.qty }}
                            </span>
                    
                            <button class="btn btn-outline-primary btn-sm qty-btn" onclick="updateQty('{{ kode }}', 1)">
                                +
                            </button>
                    
                        </div>
                    
                        <!-- LIHAT PRODUK -->
                        <a href="/product/{{ kode }}" class="text-primary small text-decoration-none d-inline-block mt-1">
                            Lihat produk
                        </a>
                    </div>

                    <a href="/cart/delete/{{ kode }}"
                       onclick="return confirm('Apakah anda yakin ingin menghapus barang ini?')"
                       class="btn btn-sm btn-outline-danger">
                        Hapus
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- SUMMARY -->
        <div class="col-lg-4">
            <div class="card summary-box shadow-sm">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Ringkasan Belanja</h5>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Total Harga</span>
                        <span class="fw-bold text-primary" id="totalHarga">
                            Rp 0
                        </span>
                    </div>

                    <button class="btn btn-primary w-100 mt-3">
                        Checkout
                    </button>
                </div>
            </div>
        </div>

    </div>
    {% else %}
    <div class="text-center mt-5">
        <h5 class="fw-semibold mb-3">
            Keranjang kamu masih kosong
        </h5>
        <a href="/" class="btn btn-primary">
            Mulai Belanja
        </a>
    </div>
    {% endif %}
</div>

<!-- ================= JS ================= -->
<script>
    const checkAll = document.getElementById("checkAll");
    const items = document.querySelectorAll(".item-check");
    const totalHargaEl = document.getElementById("totalHarga");

    function formatRupiah(num) {
        return "Rp " + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function hitungTotal() {
        let total = 0;

        items.forEach(cb => {
            const card = cb.closest(".cart-item");

            if (cb.checked) {
                const harga = parseInt(cb.dataset.harga);
                const qty = parseInt(cb.dataset.qty);
                total += harga * qty;
                card.classList.add("active");
            } else {
                card.classList.remove("active");
            }
        });

        totalHargaEl.innerText = formatRupiah(total);
    }

    items.forEach(cb => {
        cb.addEventListener("change", hitungTotal);
    });

    if (checkAll) {
        checkAll.addEventListener("change", () => {
            items.forEach(cb => cb.checked = checkAll.checked);
            hitungTotal();
        });
    }

function updateQty(kode, delta) {
    fetch("/cart/update", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            kode: kode,
            delta: delta
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById("qty-" + kode).innerText = data.qty;
            document.getElementById("totalHarga").innerText = data.total;
        }
    });
}
</script>

</body>
</html>
